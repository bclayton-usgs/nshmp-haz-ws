
apply plugin: 'java'
apply plugin: 'war'


repositories {
  jcenter()
}

dependencies {
  providedCompile 'org.apache.tomcat:tomcat-catalina:8.0.45'
  compile project(':nshmp-haz')
}

sourceSets {
  main {
    java {
      srcDirs = ['src']
    }
//    resources {
//      srcDirs = ['src']
//      exclude '**/*.java'
//    }
  }
}

ext {
  getGitTag = { gitDir -> 
    def cmd = 'git --git-dir=' + gitDir + '/.git describe --tags'
    return cmd.execute().text.replace('\n', '') ?: 'unknown'
  }
  //projectName = 'nshmp-haz-ws'
//  pp = getGitTag('.')
  //gitTag = 'git describe --tags'.execute().text.replace('\n', '') ?: 'unknown'
  //gitLink = '<a href="https://github.com/usgs/nshmp-haz-ws">' + gitTag + '</a>'
  propsPath = '/classes/java/main/service.properties'
  /* Model locations may be overridden in ~/.gradle/gradle.properties */
  model_ak_2007 = findProperty('model_ak_2007') ?: '../nshm-ak-2007'
  model_cous_2008 = findProperty('model_cous_2008') ?: '../nshm-cous-2008'
  model_cous_2014 = findProperty('model_cous_2014') ?: '../nshm-cous-2014'
}

war {
  webAppDirName = 'htdocs'
  doFirst {
    println model_ak_2007
    println getGitTag(model_ak_2007)
    
    
    /* record service and model versions */
    def props = new Properties()
    def propsFile = new File(project.buildDir.toString() + propsPath)
    propsFile.createNewFile()
    props.setProperty('app.version', getGitTag('.'))
    props.setProperty('E2007.version', getGitTag(model_ak_2007))
    props.setProperty('E2008.version', getGitTag(model_cous_2008))
    props.setProperty('E2014.version', getGitTag(model_cous_2014))
    props.store(propsFile.newWriter(), null)
  }
}




